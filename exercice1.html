<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exercice 1 ‚Äî Types & Formes de phrases</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0e17;
    --card: #1a1828;
    --accent1: #ff6b35;
    --accent2: #7c6af7;
    --accent3: #2ec4b6;
    --text: #fffffe;
    --muted: #a7a9be;
    --success: #2ec4b6;
    --error: #ff4d6d;
    --border: #2a2840;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    padding: 2rem 1rem;
    background-image: radial-gradient(ellipse at 20% 20%, rgba(124,106,247,0.12) 0%, transparent 60%),
                      radial-gradient(ellipse at 80% 80%, rgba(255,107,53,0.1) 0%, transparent 60%);
  }

  header { text-align: center; margin-bottom: 2.5rem; }
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-family: 'Syne', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
    text-decoration: none;
    margin-bottom: 1.2rem;
    transition: color 0.2s;
  }
  .back-link:hover { color: var(--accent2); }
  header h1 {
    font-family: 'Syne', sans-serif;
    font-size: clamp(1.8rem, 5vw, 3rem);
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.1;
  }
  header p { color: var(--muted); margin-top: 0.5rem; font-size: 1rem; }

  .quiz-container { max-width: 700px; margin: 0 auto; }

  .auth-screen {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 2.5rem 2rem;
    animation: slideIn 0.4s ease;
    position: relative;
    overflow: hidden;
  }
  .auth-screen::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent2), var(--accent1));
  }
  .auth-screen h2 { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 800; margin-bottom: 0.4rem; }
  .auth-screen > p { color: var(--muted); font-size: 0.95rem; margin-bottom: 2rem; }

  .field-group { margin-bottom: 1.2rem; }
  .field-group label {
    display: block;
    font-family: 'Syne', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }
  .field-group input, .field-group select {
    width: 100%;
    background: rgba(255,255,255,0.05);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    padding: 0.75rem 1rem;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
  }
  .field-group input:focus, .field-group select:focus { border-color: var(--accent2); background: rgba(124,106,247,0.08); }
  .field-group input::placeholder { color: #555; }
  .field-group select option { background: #1a1828; }

  .auth-btn {
    display: block; width: 100%; margin-top: 1.5rem; padding: 0.9rem;
    background: linear-gradient(135deg, var(--accent2), var(--accent1));
    border: none; border-radius: 12px; color: white;
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    cursor: pointer; letter-spacing: 0.05em; transition: opacity 0.2s, transform 0.2s;
  }
  .auth-btn:hover { opacity: 0.9; transform: translateY(-1px); }

  .auth-error {
    margin-top: 0.8rem; padding: 0.7rem 1rem;
    background: rgba(255,77,109,0.1); border: 1px solid rgba(255,77,109,0.3);
    border-radius: 10px; color: var(--error); font-size: 0.9rem; display: none;
  }

  .score-bar { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 2rem; }
  .score-pill {
    background: var(--card); border: 1px solid var(--border); border-radius: 999px;
    padding: 0.4rem 1.2rem; font-family: 'Syne', sans-serif; font-size: 0.9rem; font-weight: 700;
  }
  .score-pill span { color: var(--accent1); }

  .progress-bar { height: 4px; background: var(--border); border-radius: 999px; margin-bottom: 2rem; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent2), var(--accent1)); border-radius: 999px; transition: width 0.4s ease; }

  .question-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 20px;
    padding: 2rem; margin-bottom: 1.5rem; animation: slideIn 0.4s ease;
    position: relative; overflow: hidden;
  }
  .question-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent2), var(--accent1)); }

  @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  .question-num { font-family: 'Syne', sans-serif; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent2); margin-bottom: 0.8rem; font-weight: 700; }
  .phrase { font-size: 1.25rem; font-style: italic; margin-bottom: 1.5rem; padding: 1rem 1.2rem; background: rgba(124,106,247,0.1); border-left: 3px solid var(--accent2); border-radius: 0 10px 10px 0; line-height: 1.5; }
  .category-label { font-family: 'Syne', sans-serif; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin-bottom: 0.6rem; margin-top: 1.2rem; }
  .options-grid { display: flex; flex-wrap: wrap; gap: 0.6rem; }

  .opt-btn {
    background: rgba(255,255,255,0.04); border: 1.5px solid var(--border); color: var(--text);
    padding: 0.55rem 1.1rem; border-radius: 10px; font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem; cursor: pointer; transition: all 0.2s; user-select: none;
  }
  .opt-btn:hover:not(:disabled) { border-color: var(--accent2); background: rgba(124,106,247,0.15); transform: translateY(-1px); }
  .opt-btn.selected { border-color: var(--accent1); background: rgba(255,107,53,0.2); color: var(--accent1); font-weight: 500; }
  .opt-btn.correct  { border-color: var(--success); background: rgba(46,196,182,0.2); color: var(--success); font-weight: 600; }
  .opt-btn.wrong    { border-color: var(--error); background: rgba(255,77,109,0.15); color: var(--error); text-decoration: line-through; }
  .opt-btn:disabled { cursor: default; }

  .submit-btn {
    display: block; width: 100%; margin-top: 1.2rem; padding: 0.9rem;
    background: linear-gradient(135deg, var(--accent2), var(--accent1));
    border: none; border-radius: 12px; color: white;
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    cursor: pointer; letter-spacing: 0.05em; transition: opacity 0.2s, transform 0.2s;
  }
  .submit-btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
  .submit-btn:disabled { opacity: 0.4; cursor: default; }

  .next-btn {
    display: none; width: 100%; margin-top: 0.8rem; padding: 0.9rem;
    background: var(--card); border: 1.5px solid var(--accent3);
    border-radius: 12px; color: var(--accent3);
    font-family: 'Syne', sans-serif; font-size: 0.95rem; font-weight: 700;
    cursor: pointer; letter-spacing: 0.05em; transition: background 0.2s;
  }
  .next-btn:hover { background: rgba(46,196,182,0.1); }
  .next-btn.show { display: block; animation: fadeIn 0.3s ease; }

  .feedback-global {
    margin-top: 1.2rem; padding: 0.9rem 1.2rem; border-radius: 12px;
    font-size: 1rem; font-weight: 600; display: none; font-family: 'Syne', sans-serif;
  }
  .feedback-global.show { display: block; animation: fadeIn 0.3s ease; }
  .feedback-global.success { background: rgba(46,196,182,0.12); border: 1px solid rgba(46,196,182,0.3); color: var(--success); }
  .feedback-global.partial { background: rgba(255,107,53,0.1);  border: 1px solid rgba(255,107,53,0.3); color: var(--accent1); }
  .feedback-global.fail    { background: rgba(255,77,109,0.1);   border: 1px solid rgba(255,77,109,0.3); color: var(--error); }

  .explanations { display: none; margin-top: 1rem; flex-direction: column; gap: 0.8rem; }
  .explanations.show { display: flex; animation: fadeIn 0.4s ease; }
  .expl-block { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.2rem; }
  .expl-block.wrong-expl { border-left: 3px solid var(--error); }
  .expl-title { font-family: 'Syne', sans-serif; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 0.4rem; }
  .expl-verdict { font-size: 0.95rem; margin-bottom: 0.5rem; font-weight: 600; }
  .expl-verdict .wrong-label { color: var(--error); }
  .expl-verdict .right-label { color: var(--success); }
  .expl-theory { font-size: 0.9rem; color: #ccc; line-height: 1.6; background: rgba(124,106,247,0.08); padding: 0.7rem 1rem; border-radius: 8px; margin-top: 0.4rem; border-left: 2px solid var(--accent2); }
  .expl-theory strong { color: var(--accent2); }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .hint { font-size: 0.8rem; color: var(--muted); margin-top: 0.5rem; font-style: italic; }

  .results-screen {
    display: none; text-align: center; background: var(--card); border: 1px solid var(--border);
    border-radius: 20px; padding: 3rem 2rem; animation: slideIn 0.5s ease;
  }
  .results-screen h2 { font-family: 'Syne', sans-serif; font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; }
  .big-score {
    font-family: 'Syne', sans-serif; font-size: 4rem; font-weight: 800;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text; line-height: 1; margin: 1rem 0;
  }
  .student-name-display { font-size: 1rem; color: var(--muted); margin-bottom: 0.3rem; }
  .results-msg { color: var(--muted); margin-bottom: 1.5rem; font-size: 1.05rem; }

  .sending-status { padding: 0.8rem 1.2rem; border-radius: 10px; font-size: 0.9rem; margin-bottom: 1.5rem; font-weight: 500; }
  .sending-status.sending    { background: rgba(124,106,247,0.1); border: 1px solid rgba(124,106,247,0.3); color: var(--accent2); }
  .sending-status.sent       { background: rgba(46,196,182,0.12); border: 1px solid rgba(46,196,182,0.3); color: var(--success); }
  .sending-status.send-error { background: rgba(255,77,109,0.1);  border: 1px solid rgba(255,77,109,0.3); color: var(--error); font-size: 0.85rem; }

  .restart-btn {
    padding: 0.9rem 2.5rem; background: linear-gradient(135deg, var(--accent2), var(--accent1));
    border: none; border-radius: 12px; color: white;
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    cursor: pointer; letter-spacing: 0.05em; transition: opacity 0.2s; margin-right: 0.8rem;
  }
  .restart-btn:hover { opacity: 0.9; }

  .home-btn {
    padding: 0.9rem 2rem; background: transparent;
    border: 1.5px solid var(--border); border-radius: 12px; color: var(--muted);
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    cursor: pointer; letter-spacing: 0.05em; transition: border-color 0.2s, color 0.2s;
    text-decoration: none; display: inline-block;
  }
  .home-btn:hover { border-color: var(--accent2); color: var(--accent2); }
</style>
</head>
<body>

<header>
  <a class="back-link" href="index.html">‚Üê Retour aux exercices</a>
  <h1>Types &amp; Formes<br>de phrases</h1>
  <p>Exercice 1 ‚Äî Fran√ßais Sec. 3</p>
</header>

<div class="quiz-container">

  <div class="auth-screen" id="auth-screen">
    <h2>üëã Identifie-toi avant de commencer</h2>
    <p>Tes r√©sultats seront envoy√©s √† ton enseignant¬∑e automatiquement √† la fin.</p>
    <div class="field-group">
      <label>Pr√©nom</label>
      <input type="text" id="input-prenom" placeholder="Ex : Alexia" maxlength="50" />
    </div>
    <div class="field-group">
      <label>Nom</label>
      <input type="text" id="input-nom" placeholder="Ex : Tremblay" maxlength="50" />
    </div>
    <div class="field-group">
      <label>Groupe</label>
      <select id="input-groupe">
        <option value="">‚Äî S√©lectionne ton groupe ‚Äî</option>
        <option>Groupe 31</option>
        <option>Groupe 32</option>
        <option>Groupe 33</option>
      </select>
    </div>
    <div class="auth-error" id="auth-error">‚ö†Ô∏è Veuillez remplir tous les champs.</div>
    <button class="auth-btn" onclick="startQuiz()">Commencer l'exercice ‚Üí</button>
  </div>

  <div id="quiz-wrapper" style="display:none">
    <div class="score-bar">
      <div class="score-pill">Question <span id="q-num">1</span>/8</div>
      <div class="score-pill">Score : <span id="score-display">0</span></div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress" style="width:12.5%"></div>
    </div>
    <div id="quiz-area"></div>
  </div>

  <div class="results-screen" id="results"></div>
</div>

<script>
// ‚ö†Ô∏è REMPLACE PAR TON URL APPS SCRIPT
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwSosZ_7n0cdQCOZ46WqLM6kuxwqB3jgM-nLCqiZPnPb0qDmpnMpUHx4bNCRBZbg6ol/exec";

let studentData = { prenom: "", nom: "", groupe: "" };
let current = 0, score = 0;
let selections = {};
let allAnswers = [];
let sessionId  = "";
let rowNum     = null;

const theory = {
  type: {
    "D√©claratif":   "La phrase <strong>d√©clarative</strong> sert √† affirmer ou nier quelque chose. Elle se termine par un point. Ex : <em>Je mange une pomme.</em>",
    "Interrogatif": "La phrase <strong>interrogative</strong> sert √† poser une question. Elle se termine par un point d'interrogation. Ex : <em>Est-ce que tu manges ?</em>",
    "Imp√©ratif":    "La phrase <strong>imp√©rative</strong> sert √† donner un ordre ou une interdiction. Le verbe est √† l'imp√©ratif, sans sujet exprim√©. Ex : <em>Mange ta soupe !</em>",
    "Exclamatif":   "La phrase <strong>exclamative</strong> exprime une √©motion forte. Elle commence souvent par <em>Comme, Que, Quel‚Ä¶</em> Ex : <em>Comme tu es grand !</em>"
  },
  positive: {
    "Positive": "La phrase <strong>positive</strong> n'a aucun mot de n√©gation. Elle affirme quelque chose directement.",
    "N√©gative": "La phrase <strong>n√©gative</strong> contient des marqueurs de n√©gation : <em>ne‚Ä¶pas, ne‚Ä¶plus, ne‚Ä¶jamais, ne‚Ä¶rien</em>, etc."
  },
  active: {
    "Active":  "La phrase <strong>active</strong> : le sujet fait l'action. Ex : <em>Le chat mange la souris.</em>",
    "Passive": "La phrase <strong>passive</strong> : le sujet re√ßoit l'action. Structure : <em>√™tre + participe pass√© (+ par‚Ä¶)</em>. Ex : <em>La souris est mang√©e par le chat.</em>"
  },
  personal: {
    "Personnelle":   "La phrase <strong>personnelle</strong> a un sujet r√©el qui fait vraiment l'action. Ex : <em>Marie court vite.</em>",
    "Impersonnelle": "La phrase <strong>impersonnelle</strong> a un sujet <em>il</em> vide de sens. Ex : <em>Il pleut. / Il est important de‚Ä¶</em>"
  },
  emphatic: {
    "Neutre":     "La phrase <strong>neutre</strong> pr√©sente l'information sans mise en valeur particuli√®re. Ex : <em>Je mange la pomme.</em>",
    "Emphatique": "La phrase <strong>emphatique</strong> met un √©l√©ment en valeur avec <em>C'est‚Ä¶ qui / que</em> ou un pronom tonique (<em>Moi, je‚Ä¶ / Lui, il‚Ä¶</em>). Ex : <em>C'est moi qui mange la pomme.</em>"
  }
};

const catLabels = {
  type: "TYPE",
  positive: "POSITIVE ou N√âGATIVE",
  active: "ACTIVE ou PASSIVE",
  personal: "PERSONNELLE ou IMPERSONNELLE",
  emphatic: "NEUTRE ou EMPHATIQUE"
};

const questions = [
  {
    phrase: "Ne touche pas √† √ßa !",
    categories: {
      type:     { options: ["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"], answer: "Imp√©ratif" },
      positive: { options: ["Positive","N√©gative"],                                answer: "N√©gative" },
      active:   { options: ["Active","Passive"],                                   answer: "Active" },
      personal: { options: ["Personnelle","Impersonnelle"],                        answer: "Personnelle" },
      emphatic: { options: ["Neutre","Emphatique"],                                answer: "Neutre" }
    }
  },
  {
    phrase: "C'est lui qui a bris√© la fen√™tre.",
    categories: {
      type:     { options: ["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"], answer: "D√©claratif" },
      positive: { options: ["Positive","N√©gative"],                                answer: "Positive" },
      active:   { options: ["Active","Passive"],                                   answer: "Active" },
      personal: { options: ["Personnelle","Impersonnelle"],                        answer: "Personnelle" },
      emphatic: { options: ["Neutre","Emphatique"],                                answer: "Emphatique" }
    }
  },
  {
    phrase: "La pizza a √©t√© mang√©e par les √©l√®ves.",
    categories: {
      type:     { options: ["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"], answer: "D√©claratif" },
      positive: { options: ["Positive","N√©gative"],                                answer: "Positive" },
      active:   { options: ["Active","Passive"],                                   answer: "Passive" },
      personal: { options: ["Personnelle","Impersonnelle"],                        answer: "Personnelle" },
      emphatic: { options: ["Neutre","Emphatique"],                                answer: "Neutre" }
    }
  },
  {
    phrase: "Est-ce qu'il est possible de r√©ussir ce cours ?",
    categories: {
      type:     { options: ["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"], answer: "Interrogatif" },
      positive: { options: ["Positive","N√©gative"],                                answer: "Positive" },
      active:   { options: ["Active","Passive"],                                   answer: "Active" },
      personal: { options: ["Personnelle","Impersonnelle"],                        answer: "Impersonnelle" },
      emphatic: { options: ["Neutre","Emphatique"],                                answer: "Neutre" }
    }
  },
  {
    phrase: "Comme tu joues bien du piano !",
    categories: {
      type:     { options: ["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"], answer: "Exclamatif" },
      positive: { options: ["Positive","N√©gative"],                                answer: "Positive" },
      active:   { options: ["Active","Passive"],                                   answer: "Active" },
      personal: { options: ["Personnelle","Impersonnelle"],                        answer: "Personnelle" },
      emphatic: { options: ["Neutre","Emphatique"],                                answer: "Neutre" }
    }
  },
  {
    phrase: "Ce n'est pas moi qui ai vol√© le livre.",
    categories: {
      type:     { options: ["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"], answer: "D√©claratif" },
      positive: { options: ["Positive","N√©gative"],                                answer: "N√©gative" },
      active:   { options: ["Active","Passive"],                                   answer: "Active" },
      personal: { options: ["Personnelle","Impersonnelle"],                        answer: "Personnelle" },
      emphatic: { options: ["Neutre","Emphatique"],                                answer: "Emphatique" }
    }
  },
  {
    phrase: "Il est interdit de courir dans les corridors.",
    categories: {
      type:     { options: ["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"], answer: "D√©claratif" },
      positive: { options: ["Positive","N√©gative"],                                answer: "Positive" },
      active:   { options: ["Active","Passive"],                                   answer: "Active" },
      personal: { options: ["Personnelle","Impersonnelle"],                        answer: "Impersonnelle" },
      emphatic: { options: ["Neutre","Emphatique"],                                answer: "Neutre" }
    }
  },
  {
    phrase: "Le match n'a pas √©t√© gagn√© par notre √©quipe.",
    categories: {
      type:     { options: ["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"], answer: "D√©claratif" },
      positive: { options: ["Positive","N√©gative"],                                answer: "N√©gative" },
      active:   { options: ["Active","Passive"],                                   answer: "Passive" },
      personal: { options: ["Personnelle","Impersonnelle"],                        answer: "Personnelle" },
      emphatic: { options: ["Neutre","Emphatique"],                                answer: "Neutre" }
    }
  }
];


function startQuiz() {
  const prenom = document.getElementById('input-prenom').value.trim();
  const nom    = document.getElementById('input-nom').value.trim();
  const groupe = document.getElementById('input-groupe').value.trim();
  const errEl  = document.getElementById('auth-error');
  if (!prenom || !nom || !groupe) { errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';
  studentData = { prenom, nom, groupe };
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('quiz-wrapper').style.display = 'block';
  sessionId = Date.now() + "-" + Math.random().toString(36).slice(2, 7);
  sendInit();
  render();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('auth-screen').style.display !== 'none') startQuiz();
});

function render() {
  const q = questions[current];
  selections = {};
  document.getElementById('q-num').textContent = current + 1;
  document.getElementById('progress').style.width = ((current + 1) / questions.length * 100) + '%';

  let html = `<div class="question-card">
    <div class="question-num">Phrase ${current + 1} sur ${questions.length}</div>
    <div class="phrase">${q.phrase}</div>`;

  for (const [key, cat] of Object.entries(q.categories)) {
    html += `<div class="category-label">${catLabels[key]}</div><div class="options-grid" data-cat="${key}">`;
    for (const opt of cat.options) {
      html += `<button class="opt-btn" data-cat="${key}" data-val="${opt}" onclick="selectOpt(this)">${opt}</button>`;
    }
    html += `</div>`;
  }

  html += `<p class="hint">S√©lectionne une r√©ponse par cat√©gorie, puis valide.</p>
    <button class="submit-btn" id="submit-btn" onclick="submitQ()" disabled>Valider mes r√©ponses</button>
    <div class="feedback-global" id="feedback-global"></div>
    <div class="explanations" id="explanations"></div>
    <button class="next-btn" id="next-btn" onclick="nextQ()">${current < questions.length - 1 ? 'Question suivante ‚Üí' : 'Terminer et envoyer mes r√©sultats ‚Üí'}</button>
  </div>`;

  document.getElementById('quiz-area').innerHTML = html;
}

function selectOpt(btn) {
  const cat = btn.dataset.cat;
  document.querySelectorAll(`.opt-btn[data-cat="${cat}"]`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selections[cat] = btn.dataset.val;
  if (Object.keys(selections).length === Object.keys(questions[current].categories).length) {
    document.getElementById('submit-btn').disabled = false;
  }
}


function submitQ() {
  const q = questions[current];
  let correct = 0;
  const total = Object.keys(q.categories).length;
  const errors = [];
  const qAnswers = { answers: {}, correct: {} };

  for (const [key, cat] of Object.entries(q.categories)) {
    const userAnswer = selections[key];
    const isCorrect  = userAnswer === cat.answer;
    qAnswers.answers[key] = userAnswer;
    qAnswers.correct[key] = cat.answer;

    document.querySelectorAll(`.opt-btn[data-cat="${key}"]`).forEach(b => {
      b.disabled = true;
      if (b.dataset.val === cat.answer) b.classList.add('correct');
      if (b.classList.contains('selected') && !isCorrect) { b.classList.remove('selected'); b.classList.add('wrong'); }
    });

    if (isCorrect) correct++;
    else errors.push({ key, userAnswer, correctAnswer: cat.answer });
  }

  allAnswers.push(qAnswers);
  document.getElementById('submit-btn').style.display = 'none';

  const fb = document.getElementById('feedback-global');
  fb.classList.add('show');
  if (correct === total) {
    score++;
    document.getElementById('score-display').textContent = score;
    fb.className = 'feedback-global show success';
    fb.textContent = '‚úÖ Parfait ! Toutes les r√©ponses sont correctes !';
  } else if (correct >= total - 1) {
    fb.className = 'feedback-global show partial';
    fb.textContent = `üü° Presque ! ${correct}/${total} bonnes r√©ponses. Voici ce que tu as manqu√© :`;
  } else {
    fb.className = 'feedback-global show fail';
    fb.textContent = `‚ùå ${correct}/${total} bonnes r√©ponses. Lis bien les explications ci-dessous :`;
  }

  if (errors.length > 0) {
    const explDiv = document.getElementById('explanations');
    explDiv.classList.add('show');
    explDiv.innerHTML = errors.map(err => `
      <div class="expl-block wrong-expl">
        <div class="expl-title">üìå ${catLabels[err.key]}</div>
        <div class="expl-verdict">Tu as r√©pondu : <span class="wrong-label">${err.userAnswer}</span> &nbsp;‚Üí&nbsp; Bonne r√©ponse : <span class="right-label">${err.correctAnswer}</span></div>
        <div class="expl-theory">üí° <strong>Rappel :</strong> ${theory[err.key][err.correctAnswer]}</div>
      </div>`).join('');
  }

  // Envoi temps r√©el
  const nbOk = correct;
  const icon = nbOk === total ? "‚úÖ" : nbOk >= total - 1 ? "‚ö†Ô∏è" : "‚ùå";
  sendQuestion(current + 1, icon + " " + nbOk + "/" + total);

  document.getElementById('next-btn').classList.add('show');
}

function nextQ() {
  current++;
  if (current >= questions.length) showResults();
  else render();
}

function showResults() {
  document.getElementById('quiz-wrapper').style.display = 'none';
  const results = document.getElementById('results');
  results.style.display = 'block';

  const pct = Math.round(score / questions.length * 100);
  let emoji, msg;
  if (pct >= 88)      { emoji = 'üèÜ'; msg = "Excellent ! Tu ma√Ætrises tr√®s bien les types et formes !"; }
  else if (pct >= 62) { emoji = 'üëç'; msg = "Bon travail ! R√©vise les points que tu as manqu√©s."; }
  else                { emoji = 'üìö'; msg = "Continue de pratiquer, tu vas y arriver !"; }

  results.innerHTML = `
    <div style="font-size:3rem;margin-bottom:0.8rem">${emoji}</div>
    <h2>Exercice termin√© !</h2>
    <p class="student-name-display">${studentData.prenom} ${studentData.nom} ‚Äî ${studentData.groupe}</p>
    <div class="big-score">${pct}%</div>
    <p class="results-msg">${score}/${questions.length} phrases parfaites ¬∑ ${msg}</p>
    <div class="sending-status sending" id="sending-status">‚è≥ Envoi des r√©sultats √† ton enseignant¬∑e‚Ä¶</div>
    <button class="restart-btn" onclick="restart()">üîÑ Recommencer</button>
    <a class="home-btn" href="index.html">‚Üê Retour aux exercices</a>
  `;

  sendFinal(pct);
}

// ‚îÄ‚îÄ ENVOI APPS SCRIPT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiFetch(payload) {
  const resp = await fetch(APPS_SCRIPT_URL, {
    method:  'POST',
    headers: { 'Content-Type': 'text/plain' },
    body:    JSON.stringify(payload)
  });
  return resp.json();
}

async function sendInit() {
  if (APPS_SCRIPT_URL === "COLLE_TON_URL_ICI") return;
  try {
    const data = await apiFetch({
      action: "init", feuille: "exercice1",
      sessionId, prenom: studentData.prenom,
      nom: studentData.nom, groupe: studentData.groupe
    });
    if (data && data.rowNum) rowNum = data.rowNum;
  } catch(e) { console.error("sendInit:", e); }
}

function sendQuestion(qNum, result) {
  if (!rowNum || APPS_SCRIPT_URL === "COLLE_TON_URL_ICI") return;
  apiFetch({ action: "question", feuille: "exercice1", rowNum, questionNum: qNum, result })
    .catch(e => console.error("sendQuestion:", e));
}

async function sendFinal(pct) {
  const cats = ['type','positive','active','personal','emphatic'];
  const catScores = {};
  cats.forEach(c => { catScores[c] = { ok: 0, tot: questions.length }; });
  allAnswers.forEach(a => {
    cats.forEach(c => { if (a.answers[c] === a.correct[c]) catScores[c].ok++; });
  });

  const statusEl = document.getElementById('sending-status');
  if (!statusEl) return;

  if (APPS_SCRIPT_URL === "COLLE_TON_URL_ICI") {
    statusEl.className = 'sending-status send-error';
    statusEl.textContent = "‚ö†Ô∏è URL Apps Script non configur√©e.";
    return;
  }

  try {
    await apiFetch({
      action:      "final", feuille: "exercice1", rowNum,
      prenom:      studentData.prenom, nom: studentData.nom, groupe: studentData.groupe,
      score_pct:   pct, score_brut: score + "/" + questions.length,
      type_ok:     catScores.type.ok     + "/" + catScores.type.tot,
      positive_ok: catScores.positive.ok + "/" + catScores.positive.tot,
      active_ok:   catScores.active.ok   + "/" + catScores.active.tot,
      personal_ok: catScores.personal.ok + "/" + catScores.personal.tot,
      emphatic_ok: catScores.emphatic.ok + "/" + catScores.emphatic.tot
    });
    statusEl.className  = 'sending-status sent';
    statusEl.textContent = '‚úÖ R√©sultats envoy√©s √† ton enseignant¬∑e !';
  } catch(err) {
    statusEl.className  = 'sending-status send-error';
    statusEl.textContent = "‚ùå Erreur d'envoi. V√©rifie ta connexion.";
  }
}

function restart() {
  current = 0; score = 0; allAnswers = []; rowNum = null; sessionId = "";
  studentData = { prenom: "", nom: "", groupe: "" };
  document.getElementById('results').style.display = 'none';
  document.getElementById('input-prenom').value = '';
  document.getElementById('input-nom').value = '';
  document.getElementById('input-groupe').value = '';
  document.getElementById('auth-screen').style.display = 'block';
  document.getElementById('quiz-wrapper').style.display = 'none';
}
</script>
</body>
</html>
