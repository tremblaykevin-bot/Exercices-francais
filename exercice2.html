<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exercice 2 ‚Äî Types & Formes Avanc√© ‚ò†Ô∏è</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a14;
    --card: #111122;
    --accent1: #e63946;
    --accent2: #f4a261;
    --accent3: #2a9d8f;
    --text: #fffffe;
    --muted: #8888aa;
    --success: #2a9d8f;
    --error: #e63946;
    --border: #1e1e3a;
    --purple: #9b5de5;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    padding: 2rem 1rem 4rem;
    background-image:
      radial-gradient(ellipse at 15% 20%, rgba(230,57,70,0.07) 0%, transparent 55%),
      radial-gradient(ellipse at 85% 80%, rgba(155,93,229,0.06) 0%, transparent 55%);
  }

  header { text-align: center; margin-bottom: 2rem; }
  .back-link {
    display: inline-flex; align-items: center; gap: 0.4rem;
    font-family: 'Syne', sans-serif; font-size: 0.8rem; font-weight: 700;
    color: var(--muted); text-decoration: none; margin-bottom: 1.2rem; transition: color 0.2s;
  }
  .back-link:hover { color: var(--accent1); }
  .skull { font-size: 1.6rem; display: block; margin-bottom: 0.3rem; }
  header h1 {
    font-family: 'Syne', sans-serif; font-size: clamp(1.8rem, 5vw, 3rem); font-weight: 800;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1.1;
  }
  header p { color: var(--muted); margin-top: 0.5rem; font-size: 0.95rem; }
  header::after { content: ''; display: block; width: 50px; height: 2px; background: linear-gradient(90deg, var(--accent1), var(--accent2)); margin: 1rem auto 0; border-radius: 2px; }

  .quiz-container { max-width: 720px; margin: 0 auto; }

  /* AUTH */
  .auth-screen {
    background: var(--card); border: 1px solid var(--border); border-radius: 16px;
    padding: 2.5rem 2rem; animation: slideIn 0.4s ease; position: relative; overflow: hidden;
  }
  .auth-screen::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent1), var(--accent2)); }
  .auth-screen h2 { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 800; margin-bottom: 0.4rem; }
  .auth-screen > p { color: var(--muted); font-size: 0.9rem; margin-bottom: 1.8rem; }

  .field-group { margin-bottom: 1.2rem; }
  .field-group label {
    display: block; font-family: 'Syne', sans-serif; font-size: 0.75rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin-bottom: 0.45rem;
  }
  .field-group input, .field-group select {
    width: 100%; background: rgba(255,255,255,0.04); border: 1.5px solid var(--border);
    border-radius: 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 1rem;
    padding: 0.75rem 1rem; outline: none; transition: border-color 0.2s; appearance: none;
  }
  .field-group input:focus, .field-group select:focus { border-color: var(--accent1); background: rgba(230,57,70,0.06); }
  .field-group input::placeholder { color: #444; }
  .field-group select option { background: #1a1a2e; }

  .auth-btn {
    display: block; width: 100%; margin-top: 1.5rem; padding: 0.9rem;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    border: none; border-radius: 10px; color: #fff;
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    cursor: pointer; transition: opacity 0.2s, transform 0.2s; letter-spacing: 0.03em;
  }
  .auth-btn:hover { opacity: 0.9; transform: translateY(-1px); }

  .auth-error { color: var(--error); font-size: 0.85rem; margin-top: 0.75rem; display: none; }

  /* STATS */
  .stats-bar {
    display: flex; justify-content: space-between; align-items: center;
    background: var(--card); border: 1px solid var(--border); border-radius: 12px;
    padding: 0.75rem 1.2rem; margin-bottom: 1.2rem;
    font-family: 'Syne', sans-serif; font-size: 0.8rem; font-weight: 700; flex-wrap: wrap; gap: 0.5rem;
  }
  .stat-item { display: flex; flex-direction: column; align-items: center; gap: 0.1rem; }
  .stat-item .sv { font-size: 1.1rem; }
  .stat-item .sl { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
  .stat-item.sc .sv { color: var(--success); }
  .stat-item.ss .sv { color: var(--accent2); }
  .stat-item.sw .sv { color: var(--accent1); }

  /* PROGRESS */
  .progress-wrap { margin-bottom: 1.2rem; }
  .progress-track { background: #1a1a2e; border-radius: 4px; height: 6px; overflow: hidden; }
  .progress-fill {
    height: 100%; background: linear-gradient(90deg, var(--accent1), var(--accent2));
    border-radius: 4px; transition: width 0.5s cubic-bezier(.22,1,.36,1);
    box-shadow: 0 0 8px rgba(230,57,70,0.4);
  }
  .progress-label {
    display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted);
    margin-top: 0.3rem; font-family: 'Syne', sans-serif; font-weight: 700;
  }

  /* DIFF BADGE */
  .diff-badge {
    display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.2rem 0.7rem;
    border-radius: 4px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.7rem;
    letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.8rem;
  }
  .d1 { background: rgba(42,157,143,0.12); color: #2a9d8f; border: 1px solid rgba(42,157,143,0.3); }
  .d2 { background: rgba(69,123,157,0.12); color: #74b3ce; border: 1px solid rgba(69,123,157,0.3); }
  .d3 { background: rgba(247,127,0,0.12);  color: #f77f00; border: 1px solid rgba(247,127,0,0.3); }
  .d4 { background: rgba(230,57,70,0.12);  color: #e63946; border: 1px solid rgba(230,57,70,0.3); }
  .d5 { background: rgba(155,93,229,0.15); color: #9b5de5; border: 1px solid rgba(155,93,229,0.4); box-shadow: 0 0 10px rgba(155,93,229,0.2); }

  /* QUESTION CARD */
  #quiz-wrapper { display: none; }
  .q-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 16px;
    padding: 1.8rem; animation: slideIn 0.35s cubic-bezier(.22,1,.36,1);
    position: relative; overflow: hidden;
  }
  .q-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--accent1); opacity: 0.5; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }

  .q-phrase {
    background: rgba(255,255,255,0.03); border-left: 3px solid var(--accent1);
    border-radius: 0 10px 10px 0; padding: 1rem 1.2rem; font-size: 1.15rem; font-weight: 500;
    font-style: italic; color: #ddd; margin-bottom: 1.5rem; line-height: 1.5;
  }
  .q-instruction {
    font-family: 'Syne', sans-serif; font-size: 0.78rem; font-weight: 700;
    color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 1.2rem;
  }

  /* CATEGORIES */
  .categories { display: flex; flex-direction: column; gap: 1rem; }
  .cat-block {
    background: rgba(255,255,255,0.02); border: 1px solid var(--border);
    border-radius: 12px; padding: 1rem 1.1rem; transition: border-color 0.2s;
  }
  .cat-block.answered-ok  { border-color: rgba(42,157,143,0.5); background: rgba(42,157,143,0.05); }
  .cat-block.answered-bad { border-color: rgba(230,57,70,0.5);  background: rgba(230,57,70,0.05); }
  .cat-label {
    font-family: 'Syne', sans-serif; font-size: 0.72rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted);
    margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.4rem;
  }
  .options-row { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .opt-btn {
    padding: 0.5rem 1rem; border: 1.5px solid var(--border); border-radius: 8px;
    background: transparent; color: var(--text); font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.15s;
  }
  .opt-btn:hover:not(:disabled):not(.selected) { border-color: var(--accent2); background: rgba(244,162,97,0.08); }
  .opt-btn.selected { border-color: var(--accent2); background: rgba(244,162,97,0.12); color: var(--accent2); font-weight: 700; }
  .opt-btn.correct  { border-color: var(--success); background: rgba(42,157,143,0.15); color: var(--success); font-weight: 700; }
  .opt-btn.wrong    { border-color: var(--error); background: rgba(230,57,70,0.12); color: var(--error); font-weight: 700; }
  .opt-btn:disabled { cursor: default; }

  .submit-btn {
    display: block; width: 100%; margin-top: 1.5rem; padding: 0.9rem;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    border: none; border-radius: 10px; color: #fff;
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    cursor: pointer; transition: opacity 0.2s, transform 0.2s; letter-spacing: 0.03em;
  }
  .submit-btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
  .submit-btn:disabled { opacity: 0.35; cursor: default; }

  .feedback-block {
    margin-top: 1.2rem; padding: 1rem 1.2rem; border-radius: 10px;
    font-size: 0.9rem; line-height: 1.6; display: none;
  }
  .feedback-block.show { display: block; animation: fadeIn 0.25s ease; }
  .feedback-block.perfect { background: rgba(42,157,143,0.1); border: 1px solid rgba(42,157,143,0.35); }
  .feedback-block.partial { background: rgba(244,162,97,0.08); border: 1px solid rgba(244,162,97,0.35); }
  .feedback-block.nope    { background: rgba(230,57,70,0.08);  border: 1px solid rgba(230,57,70,0.35); }
  .feedback-title { font-family: 'Syne', sans-serif; font-weight: 800; margin-bottom: 0.4rem; font-size: 1rem; }
  .feedback-explanation { color: #ccc; font-size: 0.88rem; }
  .feedback-explanation strong { color: var(--text); }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .next-btn {
    display: none; width: 100%; margin-top: 0.8rem; padding: 0.85rem;
    border: 1.5px solid var(--accent1); border-radius: 10px; background: transparent;
    color: var(--accent1); font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    cursor: pointer; transition: background 0.2s, color 0.2s; letter-spacing: 0.03em;
  }
  .next-btn:hover { background: var(--accent1); color: #fff; }
  .next-btn.show { display: block; animation: fadeIn 0.3s ease; }

  /* RESULTS */
  #results { display: none; }
  .results-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 16px;
    padding: 2rem; text-align: center; animation: slideIn 0.5s ease;
  }
  .results-card h2 { font-family: 'Syne', sans-serif; font-size: clamp(1.5rem, 5vw, 2.2rem); font-weight: 800; margin-bottom: 0.3rem; }
  .big-score { font-family: 'Syne', sans-serif; font-size: clamp(3.5rem, 12vw, 6rem); font-weight: 800; line-height: 1; margin: 1rem 0; }
  .big-score .denom { font-size: 0.45em; color: var(--muted); }
  .score-quote {
    background: rgba(255,255,255,0.03); border-left: 3px solid var(--accent1); border-radius: 0 8px 8px 0;
    padding: 1rem 1.2rem; font-style: italic; font-size: 0.9rem; color: var(--muted);
    text-align: left; margin: 1.2rem 0; line-height: 1.6;
  }
  .student-name-display { font-family: 'Syne', sans-serif; font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem; }

  .section-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.7rem; margin: 1.5rem 0; text-align: center; }
  .section-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 0.8rem 0.6rem; }
  .section-card .sc-label { font-family: 'Syne', sans-serif; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin-bottom: 0.3rem; }
  .section-card .sc-val { font-family: 'Syne', sans-serif; font-size: 1.5rem; font-weight: 800; }

  .review-section { text-align: left; margin-top: 1.5rem; }
  .review-section h3 { font-family: 'Syne', sans-serif; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 0.8rem; }
  .review-item { background: rgba(255,255,255,0.02); border-radius: 10px; padding: 0.9rem 1rem; margin-bottom: 0.5rem; border-left: 3px solid; font-size: 0.85rem; line-height: 1.6; }
  .review-item.ri-ok  { border-color: var(--success); }
  .review-item.ri-no  { border-color: var(--accent1); }
  .review-item.ri-par { border-color: #f77f00; }
  .review-item .ri-phrase { font-style: italic; color: var(--accent2); font-weight: 700; display: block; margin-bottom: 0.3rem; font-size: 0.9rem; }
  .review-item .ri-correct { color: #7ee8a2; font-weight: 700; }

  .sending-status { margin-top: 1rem; padding: 0.8rem 1rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; display: none; }
  .sending-status.show { display: block; }
  .sent       { background: rgba(42,157,143,0.1);  border: 1px solid var(--success); color: #7ee8a2; }
  .send-error { background: rgba(230,57,70,0.1);   border: 1px solid var(--accent1); color: #ffb3b3; }

  .btn-row { display: flex; gap: 0.8rem; margin-top: 1rem; flex-wrap: wrap; }
  .restart-btn {
    flex: 1; padding: 0.9rem; border: 1.5px solid var(--accent1); border-radius: 10px;
    background: transparent; color: var(--accent1); font-family: 'Syne', sans-serif;
    font-size: 1rem; font-weight: 700; cursor: pointer; transition: background 0.2s, color 0.2s;
  }
  .restart-btn:hover { background: var(--accent1); color: #fff; }
  .home-btn {
    flex: 1; padding: 0.9rem; border: 1.5px solid var(--border); border-radius: 10px;
    background: transparent; color: var(--muted); font-family: 'Syne', sans-serif;
    font-size: 1rem; font-weight: 700; cursor: pointer; transition: border-color 0.2s, color 0.2s;
    text-decoration: none; display: flex; align-items: center; justify-content: center;
  }
  .home-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  .streak-flash {
    position: fixed; top: 45%; left: 50%; transform: translate(-50%,-50%) scale(0);
    font-family: 'Syne', sans-serif; font-weight: 800; font-size: 2.5rem;
    color: var(--accent2); text-shadow: 0 0 30px var(--accent2); pointer-events: none; z-index: 999;
  }
  .streak-flash.pop { animation: streakPop 0.9s cubic-bezier(.22,1,.36,1) forwards; }
  @keyframes streakPop {
    0%   { transform: translate(-50%,-50%) scale(0); opacity: 1; }
    60%  { transform: translate(-50%,-50%) scale(1.1); opacity: 1; }
    100% { transform: translate(-50%,-65%) scale(0.7); opacity: 0; }
  }

  .cp { position: fixed; animation: fall linear forwards; pointer-events: none; z-index: 9999; border-radius: 2px; }
  @keyframes fall { from { transform: translateY(-10px) rotate(0deg); opacity: 1; } to { transform: translateY(105vh) rotate(720deg); opacity: 0; } }
</style>
</head>
<body>

<header>
  <a class="back-link" href="index.html">‚Üê Retour aux exercices</a>
  <span class="skull">‚ò†Ô∏è</span>
  <h1>Types &amp; Formes ‚Äî Avanc√©</h1>
</style>
</head>
<body>

<header>
  <a class="back-link" href="index.html">‚Üê Retour aux exercices</a>
  <span class="skull">‚ò†Ô∏è</span>
  <h1>Types &amp; Formes ‚Äî Avanc√©</h1>
  <p>Exercice 2 ¬∑ 20 phrases progressives ¬∑ Identifie le type ET les 4 formes</p>
</header>

<div class="quiz-container">

  <div class="auth-screen" id="auth-screen">
    <h2>Identifie-toi avant de commencer</h2>
    <p>Tes r√©sultats seront envoy√©s √† ton enseignant¬∑e. Remplis tous les champs.</p>
    <div class="field-group">
      <label>Pr√©nom</label>
      <input type="text" id="input-prenom" placeholder="Ex : Alexia" maxlength="50" />
    </div>
    <div class="field-group">
      <label>Nom</label>
      <input type="text" id="input-nom" placeholder="Ex : Tremblay" maxlength="50" />
    </div>
    <div class="field-group">
      <label>Groupe</label>
      <select id="input-groupe">
        <option value="">‚Äî S√©lectionne ton groupe ‚Äî</option>
        <option>Groupe 31</option>
        <option>Groupe 32</option>
        <option>Groupe 33</option>
      </select>
    </div>
    <div class="auth-error" id="auth-error">‚ö†Ô∏è Veuillez remplir tous les champs.</div>
    <button class="auth-btn" onclick="startQuiz()">Commencer ‚ò†Ô∏è</button>
  </div>

  <div id="quiz-wrapper" style="display:none">
    <div class="stats-bar">
      <div class="stat-item sc"><span class="sv" id="st-ok">0</span><span class="sl">Parfaites</span></div>
      <div class="stat-item"><span class="sv" id="st-pts">0 pts</span><span class="sl">Score</span></div>
      <div class="stat-item ss"><span class="sv" id="st-streak">0üî•</span><span class="sl">S√©rie</span></div>
      <div class="stat-item sw"><span class="sv" id="st-wrong">0</span><span class="sl">Erreurs</span></div>
      <div class="stat-item"><span class="sv" id="st-pct">0%</span><span class="sl">Pr√©cision</span></div>
    </div>
    <div class="progress-wrap">
      <div class="progress-track"><div class="progress-fill" id="prog-fill"></div></div>
      <div class="progress-label">
        <span id="prog-lbl">Phrase 1 / 20</span>
        <span id="diff-lbl"></span>
      </div>
    </div>
    <div class="q-card" id="q-card">
      <div class="diff-badge" id="diff-badge"></div>
      <div class="q-phrase" id="q-phrase"></div>
      <div class="q-instruction">‚Üí Identifie le TYPE et les 4 FORMES de cette phrase</div>
      <div class="categories" id="categories"></div>
      <button class="submit-btn" id="submit-btn" onclick="submitQ()" disabled>Valider mes r√©ponses</button>
      <div class="feedback-block" id="feedback-block">
        <div class="feedback-title" id="fb-title"></div>
        <div class="feedback-explanation" id="fb-expl"></div>
      </div>
      <button class="next-btn" id="next-btn" onclick="nextQ()">Phrase suivante ‚Üí</button>
    </div>
  </div>

  <div id="results" style="display:none">
    <div class="results-card">
      <p class="student-name-display" id="student-display"></p>
      <h2 id="result-title"></h2>
      <div class="big-score" id="big-score"></div>
      <div class="score-quote" id="score-quote"></div>
      <div class="section-grid" id="section-grid"></div>
      <div class="review-section">
        <h3>üìã R√©vision d√©taill√©e</h3>
        <div id="review-list"></div>
      </div>
      <div class="sending-status" id="sending-status"></div>
      <div class="btn-row">
        <button class="restart-btn" onclick="restart()">üîÑ Recommencer</button>
        <a class="home-btn" href="index.html">‚Üê Retour aux exercices</a>
      </div>
    </div>
  </div>

</div>

<div class="streak-flash" id="streak-flash"></div>

<script>
// ‚ö†Ô∏è REMPLACE PAR TON URL APPS SCRIPT
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBtPFdoNA6udshPhdMkKIdrB4pZdtbujyrsz1-3sp0GQBfl51Y0Dyi3b6nwPVzFQ/exec";

// ‚îÄ‚îÄ DONN√âES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const catKeys   = ["type","positive","active","personal","emphatic"];
const catLabels = { type:"TYPE DE PHRASE", positive:"POSITIVE ou N√âGATIVE", active:"ACTIVE ou PASSIVE", personal:"PERSONNELLE ou IMPERSONNELLE", emphatic:"NEUTRE ou EMPHATIQUE" };
const DIFF_LABELS = {1:"üü¢ RECRUE",2:"üîµ SOLDAT",3:"üü† GUERRIER",4:"üî¥ √âLITE",5:"üíÄ GOGGINS"};
const DIFF_CLASS  = {1:"d1",2:"d2",3:"d3",4:"d4",5:"d5"};

const questions = [
  { diff:1, phrase:"Mon chien mange dans sa gamelle.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Point final + information ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Aucun ne‚Ä¶pas ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Sujet (mon chien) fait l'action ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Ordre normal ‚Üí <strong>Neutre</strong>."} } },
  { diff:1, phrase:"Est-ce que tu viens √† la f√™te ce soir ?", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Interrogatif",expl:"Est-ce que + ? ‚Üí <strong>Interrogatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Pas de ne‚Ä¶pas ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Sujet (tu) agit ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (tu) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Pas de mise en relief ‚Üí <strong>Neutre</strong>."} } },
  { diff:1, phrase:"Comme tu joues bien de la guitare !", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Exclamatif",expl:"<strong>Comme</strong> = marqueur exclamatif + ! ‚Üí <strong>Exclamatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Pas de n√©gation ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Sujet (tu) agit ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Ordre normal ‚Üí <strong>Neutre</strong>."} } },
  { diff:1, phrase:"Range ta chambre maintenant !", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Imp√©ratif",expl:"Ordre, pas de sujet exprim√© ‚Üí <strong>Imp√©ratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Pas de ne‚Ä¶pas ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Sujet sous-entendu (tu) agit ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el sous-entendu ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Pas de mise en valeur ‚Üí <strong>Neutre</strong>."} } },
  { diff:2, phrase:"La fen√™tre a √©t√© bris√©e par un √©l√®ve.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Information + point ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Pas de n√©gation ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"a √©t√© bris√©e par = √™tre + p.p. + agent ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"La fen√™tre = sujet r√©el ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Ordre normal ‚Üí <strong>Neutre</strong>."} } },
  { diff:2, phrase:"Il ne faut jamais abandonner ses r√™ves.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Affirme une id√©e + point ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ jamais = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Pas de passif ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Impersonnelle",expl:"Il faut = il impersonnel ‚Üí <strong>Impersonnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Pas de mise en relief ‚Üí <strong>Neutre</strong>."} } },
  { diff:2, phrase:"C'est toi qui as mang√© le dernier morceau de g√¢teau.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Information + point ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Pas de n√©gation ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Sujet (toi) fait l'action ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Emphatique",expl:"C'est‚Ä¶ qui = mise en valeur ‚Üí <strong>Emphatique</strong>."} } },
  { diff:2, phrase:"Ne touche pas √† √ßa !", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Imp√©ratif",expl:"Ordre sans sujet exprim√© ‚Üí <strong>Imp√©ratif</strong>. Le ! ne change pas le type."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ pas = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Pas de passif ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el sous-entendu (tu) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Pas de mise en valeur ‚Üí <strong>Neutre</strong>."} } },
  { diff:3, phrase:"N'est-il pas vrai que les r√©sultats ont √©t√© falsifi√©s par l'√©quipe ?", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Interrogatif",expl:"? + inversion ‚Üí <strong>Interrogatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ pas en d√©but = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"ont √©t√© falsifi√©s par = √™tre + p.p. + agent ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (les r√©sultats) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Inversion interrogative ‚â† mise en relief ‚Üí <strong>Neutre</strong>."} } },
  { diff:3, phrase:"Ce sont tes efforts qui ont √©t√© r√©compens√©s par le jury.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Information + point. Pas de marqueur exclamatif ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Pas de n√©gation ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"ont √©t√© r√©compens√©s par = √™tre + p.p. + agent ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (tes efforts) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Emphatique",expl:"Ce sont‚Ä¶ qui = mise en valeur du sujet ‚Üí <strong>Emphatique</strong>."} } },
  { diff:3, phrase:"Il arrive souvent des accidents √† cet endroit.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Information + point ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Pas de n√©gation ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Pas de passif ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Impersonnelle",expl:"Il impersonnel (vrai sujet = des accidents) ‚Üí <strong>Impersonnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Pas de mise en relief ‚Üí <strong>Neutre</strong>."} } },
  { diff:3, phrase:"Ce n'est pas ce livre-l√† que j'avais choisi.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Information + point ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ce n'est pas = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Pas de √™tre + p.p. + agent ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (je) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Emphatique",expl:"Ce n'est pas‚Ä¶ que = emphase n√©gative ‚Üí <strong>Emphatique</strong>."} } },
  { diff:4, phrase:"Le match n'a-t-il pas √©t√© remport√© par notre √©quipe gr√¢ce √† ces efforts ?", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Interrogatif",expl:"? + inversion ‚Üí <strong>Interrogatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ pas = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"a √©t√© remport√© par = √™tre + p.p. + agent ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (le match) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Inversion interrogative ‚â† emphase ‚Üí <strong>Neutre</strong>."} } },
  { diff:4, phrase:"C'est avec une fiert√© immense que ces m√©dailles ont √©t√© d√©cern√©es aux athl√®tes.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Pas de marqueur exclamatif ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"Positive",expl:"Pas de n√©gation ‚Üí <strong>Positive</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"ont √©t√© d√©cern√©es = √™tre + p.p. ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (ces m√©dailles) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Emphatique",expl:"C'est‚Ä¶ que = mise en valeur du CC ‚Üí <strong>Emphatique</strong>."} } },
  { diff:4, phrase:"N'aurait-il pas fallu pr√©venir les parents avant la sortie ?", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Interrogatif",expl:"? + inversion ‚Üí <strong>Interrogatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ pas = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Active",expl:"Falloir n'est pas un passif ‚Üí <strong>Active</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Impersonnelle",expl:"Il de il faudrait = impersonnel ‚Üí <strong>Impersonnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Inversion interrogative ‚â† emphase ‚Üí <strong>Neutre</strong>."} } },
  { diff:4, phrase:"C'est eux que la d√©cision n'a jamais √©t√© expliqu√©e par personne.", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"D√©claratif",expl:"Pas de marqueur exclamatif ‚Üí <strong>D√©claratif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ jamais‚Ä¶ personne = n√©gation renforc√©e ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"a jamais √©t√© expliqu√©e par = √™tre + p.p. + agent ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (la d√©cision) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Emphatique",expl:"C'est‚Ä¶ que = mise en valeur ‚Üí <strong>Emphatique</strong>."} } },
  { diff:5, phrase:"N'est-ce pas avec honte que ces donn√©es n'ont jamais √©t√© v√©rifi√©es par quiconque ?", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Interrogatif",expl:"? + inversion ‚Üí <strong>Interrogatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ jamais = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"ont jamais √©t√© v√©rifi√©es par = √™tre + p.p. + agent ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (ces donn√©es) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Emphatique",expl:"N'est-ce pas‚Ä¶ que = emphase interrogative ‚Üí <strong>Emphatique</strong>."} } },
  { diff:5, phrase:"Que ces r√©sultats-l√† n'auront jamais √©t√© accept√©s par l'ensemble des juges !", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Exclamatif",expl:"<strong>Que</strong> en d√©but = marqueur exclamatif + ! ‚Üí <strong>Exclamatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ jamais = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"auront √©t√© accept√©s par = futur ant√©rieur passif ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (ces r√©sultats-l√†) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Pas de c'est‚Ä¶qui/que ‚Üí <strong>Neutre</strong>."} } },
  { diff:5, phrase:"Est-il vraiment n√©cessaire que toutes ces d√©cisions n'aient jamais √©t√© soumises √† un vote ?", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Interrogatif",expl:"? + inversion ‚Üí <strong>Interrogatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"n'aient jamais = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"aient √©t√© soumises = passif au subjonctif ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Impersonnelle",expl:"Il de il est n√©cessaire = impersonnel ‚Üí <strong>Impersonnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Inversion interrogative ‚â† emphase ‚Üí <strong>Neutre</strong>."} } },
  { diff:5, phrase:"Comme ces sacrifices n'ont jamais √©t√© reconnus par ceux qui auraient d√ª le faire !", cats:{ type:{opts:["D√©claratif","Interrogatif","Imp√©ratif","Exclamatif"],ans:"Exclamatif",expl:"<strong>Comme</strong> en d√©but = marqueur exclamatif + ! ‚Üí <strong>Exclamatif</strong>."}, positive:{opts:["Positive","N√©gative"],ans:"N√©gative",expl:"ne‚Ä¶ jamais = n√©gation ‚Üí <strong>N√©gative</strong>."}, active:{opts:["Active","Passive"],ans:"Passive",expl:"ont jamais √©t√© reconnus par = √™tre + p.p. + agent ‚Üí <strong>Passive</strong>."}, personal:{opts:["Personnelle","Impersonnelle"],ans:"Personnelle",expl:"Sujet r√©el (ces sacrifices) ‚Üí <strong>Personnelle</strong>."}, emphatic:{opts:["Neutre","Emphatique"],ans:"Neutre",expl:"Pas de c'est‚Ä¶qui/que ‚Üí <strong>Neutre</strong>."} } }
];

// ‚îÄ‚îÄ √âTAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let studentData   = { prenom:"", nom:"", groupe:"" };
let sessionId     = "";
let rowNum        = null;
let cur = 0, totalPts = 0, maxPts = 0, streak = 0, bestStreak = 0, wrongCount = 0;
let allAnswers    = [];
let selections    = {};
let submitted     = false;   // garde anti-double-clic
let sectionScores = { type:{ok:0,tot:0}, positive:{ok:0,tot:0}, active:{ok:0,tot:0}, personal:{ok:0,tot:0}, emphatic:{ok:0,tot:0} };

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startQuiz() {
  const prenom = document.getElementById('input-prenom').value.trim();
  const nom    = document.getElementById('input-nom').value.trim();
  const groupe = document.getElementById('input-groupe').value;
  const errEl  = document.getElementById('auth-error');
  if (!prenom || !nom || !groupe) { errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';
  studentData = { prenom, nom, groupe };
  sessionId = Date.now() + "-" + Math.random().toString(36).slice(2,7);
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('quiz-wrapper').style.display = 'block';
  render();
  sendInit();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('auth-screen').style.display !== 'none') startQuiz();
});

// ‚îÄ‚îÄ RENDU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  if (cur >= questions.length) { showResults(); return; }

  submitted  = false;
  selections = {};
  const q    = questions[cur];

  // Animation
  const card = document.getElementById('q-card');
  card.style.animation = 'none'; card.offsetHeight; card.style.animation = '';

  // Infos phrase
  const db = document.getElementById('diff-badge');
  db.textContent = DIFF_LABELS[q.diff];
  db.className   = 'diff-badge ' + DIFF_CLASS[q.diff];
  document.getElementById('q-phrase').textContent = `¬´ ${q.phrase} ¬ª`;
  document.getElementById('prog-fill').style.width = `${(cur / questions.length) * 100}%`;
  document.getElementById('prog-lbl').textContent  = `Phrase ${cur + 1} / ${questions.length}`;
  document.getElementById('diff-lbl').textContent  = DIFF_LABELS[q.diff];

  // Cat√©gories
  const catsEl = document.getElementById('categories');
  catsEl.innerHTML = '';
  catKeys.forEach(key => {
    const block = document.createElement('div');
    block.className = 'cat-block';
    block.id = `cat-${key}`;
    block.innerHTML = `<div class="cat-label"><span>${catLabels[key]}</span><span class="check" id="chk-${key}"></span></div>
      <div class="options-row" id="row-${key}"></div>`;
    catsEl.appendChild(block);
    const row = document.getElementById(`row-${key}`);
    q.cats[key].opts.forEach(opt => {
      const btn = document.createElement('button');
      btn.className   = 'opt-btn';
      btn.textContent = opt;
      btn.onclick     = () => selectOpt(key, opt, btn);
      row.appendChild(btn);
    });
  });

  // Boutons
  const submitBtn = document.getElementById('submit-btn');
  submitBtn.disabled = true;
  submitBtn.style.display = 'block';
  document.getElementById('feedback-block').className = 'feedback-block';
  document.getElementById('next-btn').className       = 'next-btn';

  // Label dernier bouton
  document.getElementById('next-btn').textContent =
    cur < questions.length - 1 ? 'Phrase suivante ‚Üí' : 'Voir mes r√©sultats ‚Üí';

  updateStats();
}

// ‚îÄ‚îÄ S√âLECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectOpt(key, val, btn) {
  if (submitted) return;
  document.querySelectorAll(`#row-${key} .opt-btn`).forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selections[key] = val;
  document.getElementById('submit-btn').disabled = (Object.keys(selections).length < catKeys.length);
}

// ‚îÄ‚îÄ VALIDATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function submitQ() {
  if (submitted) return;
  submitted = true;
  document.getElementById('submit-btn').disabled = true;

  const q      = questions[cur];
  let qCorrect = 0;
  const qTotal = catKeys.length;

  catKeys.forEach(key => {
    const selected = selections[key];
    const correct  = q.cats[key].ans;
    const block    = document.getElementById(`cat-${key}`);
    const chk      = document.getElementById(`chk-${key}`);

    document.querySelectorAll(`#row-${key} .opt-btn`).forEach(b => {
      b.disabled = true;
      if (b.textContent === correct)                         b.classList.add('correct');
      if (b.textContent === selected && selected !== correct) b.classList.add('wrong');
    });

    const ok = (selected === correct);
    block.classList.add(ok ? 'answered-ok' : 'answered-bad');
    chk.textContent = ok ? '‚úÖ' : '‚ùå';
    sectionScores[key].tot++;
    if (ok) { sectionScores[key].ok++; qCorrect++; }
  });

  // Points
  const qPts = qCorrect * 5 + (qCorrect === qTotal ? 5 : 0);
  totalPts += qPts;
  maxPts   += qTotal * 5 + 5;

  // Streak
  if (qCorrect === qTotal) {
    streak++;
    if (streak > bestStreak) bestStreak = streak;
    if (streak % 3 === 0)   flashStreak(streak + " üî•");
  } else {
    wrongCount += (qTotal - qCorrect);
    streak = 0;
  }

  allAnswers.push({
    phrase: q.phrase, diff: q.diff,
    selected: {...selections},
    correct: Object.fromEntries(catKeys.map(k => [k, q.cats[k].ans])),
    qCorrect, qTotal
  });

  // Feedback
  const fb    = document.getElementById('feedback-block');
  const title = document.getElementById('fb-title');
  const expl  = document.getElementById('fb-expl');

  if (qCorrect === qTotal) {
    fb.className    = 'feedback-block show perfect';
    title.textContent = ['üéØ Parfait !','üî• Flawless !','üíÄ Trop fort !','üèÜ Excellent !'][Math.floor(Math.random()*4)];
    expl.innerHTML  = '';
  } else if (qCorrect >= 3) {
    fb.className    = 'feedback-block show partial';
    title.textContent = `üëç ${qCorrect}/5 ‚Äî Presque !`;
    expl.innerHTML  = buildExpls(q);
  } else {
    fb.className    = 'feedback-block show nope';
    title.textContent = `üí° ${qCorrect}/5 ‚Äî Explications :`;
    expl.innerHTML  = buildExpls(q);
  }

  document.getElementById('submit-btn').style.display = 'none';
  document.getElementById('next-btn').className       = 'next-btn show';

  // Envoi temps r√©el
  const icon = qCorrect === qTotal ? "‚úÖ" : qCorrect >= 3 ? "‚ö†Ô∏è" : "‚ùå";
  sendQuestion(cur + 1, icon + " " + qCorrect + "/" + qTotal);

  updateStats();
}

function buildExpls(q) {
  return catKeys
    .filter(k => selections[k] !== q.cats[k].ans)
    .map(k => `<div style="margin-top:0.5rem"><em style="color:#f4a261">${catLabels[k]}</em> ‚Üí ${q.cats[k].expl}</div>`)
    .join('');
}

function nextQ() {
  cur++;
  render();
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
  document.getElementById('st-ok').textContent     = allAnswers.filter(a => a.qCorrect === a.qTotal).length;
  document.getElementById('st-pts').textContent    = totalPts + ' pts';
  document.getElementById('st-streak').textContent = streak + 'üî•';
  document.getElementById('st-wrong').textContent  = wrongCount;
  const pct = maxPts > 0 ? Math.round(totalPts / maxPts * 100) : 0;
  document.getElementById('st-pct').textContent    = pct + '%';
}

function flashStreak(msg) {
  const el = document.getElementById('streak-flash');
  el.textContent = msg;
  el.className = 'streak-flash';
  el.offsetHeight;
  el.className = 'streak-flash pop';
}

// ‚îÄ‚îÄ R√âSULTATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showResults() {
  document.getElementById('quiz-wrapper').style.display = 'none';
  document.getElementById('results').style.display      = 'block';

  const finalPct = maxPts > 0 ? Math.round(totalPts / maxPts * 100) : 0;
  let color, title, quote;
  if      (finalPct >= 90) { color='#9b5de5'; title='üíÄ GOGGINS LEVEL'; quote='"Who\'s gonna carry the boats?" Toi. Score l√©gendaire.'; launchConfetti(); }
  else if (finalPct >= 75) { color='#e63946'; title='üî¥ √âLITE';         quote='"The only way to change your life is to go to war with yourself." Presque au sommet.'; }
  else if (finalPct >= 60) { color='#f77f00'; title='üü† GUERRIER';      quote='"You are not who you think you are. You are more." Continue.'; }
  else if (finalPct >= 45) { color='#457b9d'; title='üîµ SOLDAT';        quote='"Don\'t stop when you\'re tired. Stop when you\'re done." Recommence.'; }
  else                     { color='#2a9d8f'; title='üü¢ RECRUE';        quote='"Stay hard." Retourne √©tudier ta th√©orie et recommence.'; }

  document.getElementById('student-display').textContent = `${studentData.prenom} ${studentData.nom} ‚Äî ${studentData.groupe}`;
  document.getElementById('result-title').textContent    = title;
  document.getElementById('result-title').style.color    = color;
  const bs = document.getElementById('big-score');
  bs.style.color = color;
  bs.innerHTML   = `${finalPct}<span class="denom">%</span>`;
  document.getElementById('score-quote').textContent = quote;

  const sLabels = { type:'TYPE', positive:'POS/N√âG', active:'ACT/PASS', personal:'PERS/IMPERS', emphatic:'NEUTRE/EMPH' };
  document.getElementById('section-grid').innerHTML = catKeys.map(k => {
    const sc = sectionScores[k];
    const p  = sc.tot > 0 ? Math.round(sc.ok / sc.tot * 100) : 0;
    const c  = p >= 80 ? '#2a9d8f' : p >= 50 ? '#f77f00' : '#e63946';
    return `<div class="section-card"><div class="sc-label">${sLabels[k]}</div><div class="sc-val" style="color:${c}">${sc.ok}/${sc.tot}</div></div>`;
  }).join('');

  document.getElementById('review-list').innerHTML = allAnswers.map((a, i) => {
    const cls  = a.qCorrect === a.qTotal ? 'ri-ok' : a.qCorrect >= 3 ? 'ri-par' : 'ri-no';
    const icon = a.qCorrect === a.qTotal ? '‚úÖ' : a.qCorrect >= 3 ? '‚ö†Ô∏è' : '‚ùå';
    const wrongs = catKeys.filter(k => a.selected[k] !== a.correct[k])
      .map(k => `<div>‚Ä¢ ${catLabels[k]} : <span class="ri-correct">${a.correct[k]}</span></div>`).join('');
    return `<div class="review-item ${cls}">
      <span class="ri-phrase">${icon} Phrase ${i+1} ‚Äî ${a.phrase}</span>
      <span style="color:var(--muted);font-size:0.8rem">${DIFF_LABELS[a.diff]} ¬∑ ${a.qCorrect}/${a.qTotal} bonnes</span>
      ${wrongs ? `<div style="margin-top:0.4rem;color:var(--muted);font-size:0.8rem">${wrongs}</div>` : ''}
    </div>`;
  }).join('');

  sendFinal(finalPct);
}

// ‚îÄ‚îÄ ENVOI APPS SCRIPT (temps r√©el) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiFetch(payload) {
  const resp = await fetch(APPS_SCRIPT_URL, {
    method:  'POST',
    headers: { 'Content-Type': 'text/plain' },
    body:    JSON.stringify(payload)
  });
  return resp.json();
}

async function sendInit() {
  try {
    const data = await apiFetch({
      action: "init",
      feuille: "exercice2",
      sessionId,
      prenom: studentData.prenom,
      nom: studentData.nom,
      groupe: studentData.groupe
    });
    if (data && data.rowNum) rowNum = data.rowNum;
  } catch (e) {
    console.error("sendInit:", e);
  }
}

function sendQuestion(qNum, result) {
  if (!rowNum) return;
  apiFetch({
    action: "question",
    feuille: "exercice2",
    rowNum,
    questionNum: qNum,
    result
  }).catch(e => console.error("sendQuestion:", e));
}

async function sendFinal(pct) {
  const statusEl = document.getElementById('sending-status');
  if (!statusEl) return;

  statusEl.style.cssText = 'display:block;margin-top:1rem;padding:0.8rem 1rem;border-radius:8px;font-size:0.9rem;font-weight:600;background:rgba(124,106,247,0.1);border:1px solid rgba(124,106,247,0.3);color:#c8c0ff;';
  statusEl.textContent = '‚è≥ Envoi des r√©sultats‚Ä¶';

  const qResults = allAnswers.map(a => {
    const icon = a.qCorrect === a.qTotal ? "‚úÖ" : a.qCorrect >= 3 ? "‚ö†Ô∏è" : "‚ùå";
    return icon + " " + a.qCorrect + "/" + a.qTotal;
  }).join(", ");

  const payload = {
    action:          "final",
    feuille:         "exercice2",
    rowNum,
    prenom:          studentData.prenom,
    nom:             studentData.nom,
    groupe:          studentData.groupe,
    score_pct:       pct,
    total_pts:       totalPts,
    max_pts:         maxPts,
    meilleure_serie: bestStreak,
    type_ok:         sectionScores.type.ok     + "/" + sectionScores.type.tot,
    positive_ok:     sectionScores.positive.ok + "/" + sectionScores.positive.tot,
    active_ok:       sectionScores.active.ok   + "/" + sectionScores.active.tot,
    personal_ok:     sectionScores.personal.ok + "/" + sectionScores.personal.tot,
    emphatic_ok:     sectionScores.emphatic.ok + "/" + sectionScores.emphatic.tot,
    q_results:       qResults
  };

  try {
    const res = await apiFetch(payload);
    if (res && res.status === "ok") {
      statusEl.style.cssText = 'display:block;margin-top:1rem;padding:0.8rem 1rem;border-radius:8px;font-size:0.9rem;font-weight:600;background:rgba(42,157,143,0.12);border:1px solid rgba(42,157,143,0.3);color:#7ee8a2;';
      statusEl.textContent = '‚úÖ R√©sultats envoy√©s √† ton enseignant¬∑e !';
    } else {
      throw new Error((res && res.message) ? res.message : "R√©ponse serveur invalide");
    }
  } catch (err) {
    statusEl.style.cssText = 'display:block;margin-top:1rem;padding:0.8rem 1rem;border-radius:8px;font-size:0.9rem;font-weight:600;background:rgba(230,57,70,0.12);border:1px solid rgba(230,57,70,0.35);color:#ffb4ba;';
    statusEl.textContent = '‚ùå √âchec de l\'envoi. R√©essaie plus tard.';
    console.error(err);
  }
}


// ‚îÄ‚îÄ RESTART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function restart() {
  cur = 0; totalPts = 0; maxPts = 0; streak = 0; bestStreak = 0; wrongCount = 0;
  allAnswers = []; rowNum = null; sessionId = ""; submitted = false;
  sectionScores = { type:{ok:0,tot:0}, positive:{ok:0,tot:0}, active:{ok:0,tot:0}, personal:{ok:0,tot:0}, emphatic:{ok:0,tot:0} };
  studentData = { prenom:"", nom:"", groupe:"" };
  document.getElementById('results').style.display      = 'none';
  document.getElementById('quiz-wrapper').style.display = 'none';
  ['input-prenom','input-nom','input-groupe'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('auth-screen').style.display  = 'block';
}

// ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function launchConfetti() {
  const cols = ['#e63946','#f4a261','#2a9d8f','#9b5de5','#ffd93d'];
  for (let i = 0; i < 100; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'cp';
      const sz = Math.random() * 8 + 4;
      el.style.cssText = `left:${Math.random()*100}vw;width:${sz}px;height:${sz}px;background:${cols[Math.floor(Math.random()*cols.length)]};animation-duration:${(Math.random()*1.5+1.5).toFixed(1)}s;border-radius:${Math.random()>0.5?'50%':'2px'};position:fixed;animation:fall linear forwards;pointer-events:none;z-index:9999;`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3500);
    }, i * 25);
  }
}
</script>
</body>
</html>
